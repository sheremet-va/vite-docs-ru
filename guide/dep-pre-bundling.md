# Предварительная сборка зависимостей

Когда вы запускаете `vite` в первый раз, вы можете заметить это сообщение:

```
Optimizable dependencies detected:
react, react-dom
Pre-bundling them to speed up dev server page load...
(this will be run only when your dependencies have changed)
```

## Причина

Vite делает так называемую "предварительную сборку зависимостей". Этот процесс служит двум целям:

1. **Совместимость CommonJS и UMD:** Во время разработки Vite обслуживает весь код как нативный ESM. Следовательно, Vite должен сначала преобразовать зависимости, которые поставляются как CommonJS или UMD, в ESM.

   При преобразовании CommonJS зависимостей Vite выполняет умный анализ импорта, так что именованный импорт в CommonJS модулях будет работать должным образом, даже если экспорт назначается динамически (например, React):

   ```js
   // работает как положено
   import React, { useState } from 'react'
   ```

2. **Производительность:** Vite преобразует ESM зависимости со многими внутренними модулями в один модуль для повышения производительности последующей загрузки страницы.

   Некоторые пакеты поставляют свои ES модули в виде множества отдельных файлов, импортирующих других. Например, [`lodash-es` имеет более 600 внутренних модулей](https://unpkg.com/browse/lodash-es/)! Когда мы выполняем `import {debounce} from 'lodash-es'`, браузер одновременно запускает 600+ HTTP-запросов! Несмотря на то, что у сервера нет проблем с их обработкой, большое количество запросов создает перегрузку сети на стороне браузера, в результате чего страница загружается заметно медленнее.

   Предварительно объединив `lodash-es` в один модуль, нам потребуется только один HTTP-запрос!

## Автоматическое обнаружение зависимостей

Если существующий кеш не найден, Vite просканирует ваш исходный код и автоматически обнаружит импорт зависимостей (т.е. "bare imports", который должен быть разрешен из `node_modules`) и будет использовать эти найденные импорты в качестве точек входа для предварительной сборки. Предварительная сборка выполняется с помощью `esbuild`, поэтому это происходит очень быстро.

После того, как сервер уже запущен, если обнаружен новый импорт зависимостей, которых еще нет в кеше, Vite повторно запустит процесс сборки зависимостей и перезагрузит страницу.

## Монорепозитории и связанные зависимости

В настройке монорепозитория зависимость может быть связанным пакетом из того же репозитория. Vite автоматически обнаруживает зависимости, которые не разрешаются из `node_modules`, и обрабатывает связаннуе зависимости как исходный код. Vite не будет пытаться сбилдить эту зависимость, а вместо этого сделает анализ списка связанных зависимостей.

## Настройка поведения

Алгоритмы обнаружения зависимостей по умолчанию не всегда могут быть подходящими. В случаях, когда вы хотите явно включить/исключить зависимости из списка, используйте [параметры `optimizeDeps` конфигурации](/config/#dep-optimization-options).

Типичный вариант использования `optimizeDeps.include` или `optimizeDeps.exclude` - это когда у вас есть импорт, который нельзя напрямую обнаружить в исходном коде. Например, возможный импорт создается в результате преобразования плагина. Это означает, что Vite не сможет обнаружить импорт при первоначальном сканировании - а увидит его только после того, как файл будет запрошен браузером и преобразован. Это приведет к незамедлительной пересборки сервера после его запуска.

Для этого можно использовать как `include`, так и `exclude`. Если зависимость большая (со многими внутренними модулями) или CommonJS, вам следует включить ее; Если зависимость небольшая и уже является валидным ESM, вы можете исключить ее и позволить браузеру загрузить ее напрямую.

## Кэширование

### Кэш файловой системы

Vite кэширует предварительно собранные зависимости в `node_modules/.vite`. И определяет, нужно ли повторно запускать этап предварительной сборки на основе нескольких источников:

- Список `dependencies` в вашем `package.json`
- lockfile'ы пакетных менеджеров, например `package-lock.json`, `yarn.lock`, или `pnpm-lock.yaml`.
- Соответствующие поля в вашем `vite.config.js`, если они есть.

Процес пересборки потребуется запустить только в том случае, когда что-то из вышеперечисленного изменится.

Если по какой-то причине вы хотите заставить Vite повторно пересобрать зависимости, вы можете запустить сервер разработки с параметром командной строки `--force`, либо вручную удалить каталог кеша `node_modules/.vite`.

### Кэш браузера

Разрешенные запросы зависимостей строго кэшируются с HTTP заголовками `max-age=31536000,immutable` для повышения производительности перезагрузки страницы во время разработки. После кеширования эти запросы никогда больше не попадут на сервер. Они автоматически инвалидируются добавлением в запрос версии, если была установлена другая версия (как это отражено в lockfile вашего пакетного менеджера). Если вы хотите отладить свои зависимости путем внесения локальных изменений, вы можете:

1. Временно отключите кеш на вкладке «Сеть» в инструментах разработчика вашего браузера;
2. Перезапустить сервер разработки Vite с флагом `--force`, чтобы повторно пересобрать зависимости;
3. Обновить страницу.
