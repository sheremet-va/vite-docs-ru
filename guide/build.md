# Сборка для production

Когда настало время задеплоить ваше приложение в production среду, просто запустите команду `vite build`. По умолчанию Vite использует `<root>/index.html` в качестве точки входа в билд и создает сборку приложения, которая подходит для запуска на статическом хостинге. Ознакомьтесь с гайдами о [Развертывании статического сайта](./static-deploy) по популярным сервисам.

## Совместимость с браузерами

Production сборка предполагает поддержку современного JavaScript. По умолчанию vite нацелен на браузеры, которые поддерживают [нативный ESM script тег](https://caniuse.com/es6-module) и [нативные динамические ESM импорты](https://caniuse.com/es6-module-dynamic-import). В качестве справки vite использует этот запрос для [browserslist](https://github.com/browserslist/browserslist):

```
defaults and supports es6-module and supports es6-module-dynamic-import, not opera > 0, not samsung > 0, not and_qq > 0
```

Вы можете указать кастомные цели с помощью [параметра `build.target` конфигурации](/config/#build-target), где самая низкая - `es2015`.

Обратите внимание, что по умолчанию Vite обрабатывает только синтаксические преобразования и **не добавляет полифиллы**. Вы можете использовать [Polyfill.io](https://polyfill.io/v3/), который представляет из себя сервис, который автоматически генерирует пакеты полифиллов на основе строки UserAgent браузера пользователя.

Устаревшие браузеры могут поддерживаться через [@vitejs/plugin-legacy](https://github.com/vitejs/vite/tree/main/packages/plugin-legacy), который автоматически генерирует легаси чанки и соответствующие полифилы для функций языка ES. Легаси чанки будут загружаются только в браузерах, не имеющих нативной ESM поддержки.

## Публичный базовый путь

- Related: [Asset Handling](./assets)

Если вы деплоите свой проект по вложенному публичному пути, просто укажите [`base` параметр конфигурации](/config/#base), и все пути к ресурсам будут соответственно переписаны. Этот параметр также можно указать как флаг командной строки, например `vite build --base=/my/public/path/`.

JS-импортированные URL-адреса ресурсов, `url()` ссылки в CSS и ссылки на ресурсы в ваших `.html` файлах автоматически скорректируются с учетом этого параметра во время сборки.

Исключение составляют случаи, когда вам нужно динамически объединять URL-адреса на лету. В этом случае вы можете использовать глобально внедренную переменную `import.meta.env.BASE_URL`, которая будет публичным базовым путем. Обратите внимание, что эта переменная статически заменяется во время сборки, поэтому она должна отображаться в точности как есть (т.е. `import.meta.env['BASE_URL']` не будет работать).

## Настройка сборки

Сборку можно настроить с помощью различных [параметров конфигурации](/config/#build-options). В частности, вы можете напрямую настроить базовые [параметры Rollup](https://rollupjs.org/guide/en/#big-list-of-options) через `build.rollupOptions`:

```js
// vite.config.js
module.exports = {
  build: {
    rollupOptions: {
      // https://rollupjs.org/guide/en/#big-list-of-options
    }
  }
}
```

Например, вы можете указать несколько Rollup выходов с плагинами, которые применяются только во время сборки.

## Пересборка при изменении файлов

Вы можете включить rollup watcher через `vite build --watch`. Или можете напрямую настроить базовые [`WatcherOptions`](https://rollupjs.org/guide/en/#watch-options) через `build.watch`:

```js
// vite.config.js
module.exports = {
  build: {
    watch: {
      // https://rollupjs.org/guide/en/#watch-options
    }
  }
}
```

## Многостраничное приложение

Предположим, у вас есть следующая структура исходного кода:

```
├── package.json
├── vite.config.js
├── index.html
├── main.js
└── nested
    ├── index.html
    └── nested.js
```

Во время разработки просто перейдите или создайте ссылку на `/nested/` - это работает так же, как и для обычного статического файлового сервера.

Во время сборки все, что вам нужно сделать, это указать несколько `.html` файлов в качестве точек входа:

```js
// vite.config.js
const { resolve } = require('path')

module.exports = {
  build: {
    rollupOptions: {
      input: {
        main: resolve(__dirname, 'index.html'),
        nested: resolve(__dirname, 'nested/index.html')
      }
    }
  }
}
```

Если вы укажете другой корень, помните, что `__dirname` по-прежнему будет папкой вашего файла vite.config.js при разрешении входных путей. Следовательно, вам нужно будет добавить `root` запись в аргументы `resolve`.

## Режим библиотеки

Когда вы разрабатываете библиотеку, ориентированную на браузер, вы, вероятно, проводите большую часть времени на тестовой/демо странице, которая импортирует вашу фактическую библиотеку. В Vite вы можете использовать свой `index.html` для этой цели, чтобы обеспечить беспроблемную разработку.

Когда пришло время собрать вашу библиотеку для распространения, используйте [параметр `build.lib` конфигурации](/config/#build-lib). Не забудьте также экстернализовать любые зависимости, которые вы не хотите включать в свою библиотеку, например `vue` или `react`:

```js
// vite.config.js
const path = require('path')

module.exports = {
  build: {
    lib: {
      entry: path.resolve(__dirname, 'lib/main.js'),
      name: 'MyLib'
    },
    rollupOptions: {
      // убедитесь, что вы используете внешние зависимости, 
      // которые не должны быть включены в сборку вашей библиотеки
      external: ['vue'],
      output: {
        // Предоставляем глобальные переменные для использования в UMD сборке
        // для внешних зависимостей
        globals: {
          vue: 'Vue'
        }
      }
    }
  }
}
```

При запуске `vite build` с этой конфигурацией, используется Rollup пресет, ориентированный на сборку библиотек, который создает два формата сборки: `es` и `umd` (настраиваемые через `build.lib`):

```
$ vite build
building for production...
[write] my-lib.es.js 0.08kb, brotli: 0.07kb
[write] my-lib.umd.js 0.30kb, brotli: 0.16kb
```

Рекомендуемый `package.json` для вашей библиотеки:

```json
{
  "name": "my-lib",
  "files": ["dist"],
  "main": "./dist/my-lib.umd.js",
  "module": "./dist/my-lib.es.js",
  "exports": {
    ".": {
      "import": "./dist/my-lib.es.js",
      "require": "./dist/my-lib.umd.js"
    }
  }
}
```
